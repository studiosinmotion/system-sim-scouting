<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout App - SIM Scouting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    </style>
</head>
<body class="bg-[#111111] min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Card -->
    <div class="bg-[#1a1a1a] p-8 rounded-2xl shadow-2xl shadow-black/50 max-w-sm w-full text-center border border-gray-800 transform transition-all hover:scale-[1.01]">
        
        <!-- Icon / Logo Placeholder -->
        <div class="text-5xl mb-6 animate-bounce">
            üéÅ
        </div>

        <!-- VIEW: DASHBOARD (Sharing) -->
        <div id="view-dashboard" class="hidden">
            <!-- Header / Greeting -->
            <h1 class="text-2xl font-bold text-white mb-3">Hi <span id="scout-name" class="text-[#00b4d8]">Scout</span>, <br>trainiere nicht allein!</h1>
            
            <!-- Subline -->
            <p class="text-gray-400 mb-8 font-medium leading-relaxed">
                Schenk deinen Freunden Fitness! <br>
                <span class="text-sm opacity-60">Dein Code ist wertvoll. Teile ihn jetzt.</span>
            </p>

            <!-- STATS CARD (New Feature) -->
            <!-- STATS CARD (New Feature) -->
            <!-- STATS CARD (New Feature) -->
            <div id="stats-loader" class="mb-8 text-center text-gray-500 animate-pulse">
                <i class="fas fa-spinner fa-spin mr-2"></i> Lade Statistik...
            </div>

            <div id="stats-container" class="mb-8 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <!-- Count -->
                    <div class="bg-[#111] p-4 rounded-xl border border-gray-800 flex flex-col items-center justify-center">
                        <span class="text-3xl font-bold text-white" id="stats-count">-</span>
                        <span class="text-xs text-gray-500 uppercase tracking-wider mt-1">Leads</span>
                    </div>
                    <!-- Rank -->
                    <div class="bg-[#111] p-4 rounded-xl border border-gray-800 flex flex-col items-center justify-center">
                        <span class="text-xl font-bold text-gray-400" id="stats-rank">-</span>
                        <span class="text-xs text-gray-500 uppercase tracking-wider mt-1">Status</span>
                    </div>
                </div>
            </div>

            <!-- EMPTY STATE (No leads yet) -->
            <div id="stats-empty" class="mb-8 hidden">
                <div class="bg-gray-800/30 p-4 rounded-xl border border-gray-800 text-gray-400 text-sm">
                    Du hast noch keine Freunde eingeladen. <br>
                    <span class="text-white font-bold">Teile deinen Link und werde zur Legende! üöÄ</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col gap-4">
                
                <!-- WhatsApp Button -->
                <a id="whatsapp-btn" href="#" target="_blank" class="bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold py-4 px-6 rounded-xl flex items-center justify-center transition-all shadow-lg hover:shadow-green-900/50 group">
                    <i class="fab fa-whatsapp text-3xl mr-3 group-hover:scale-110 transition-transform"></i>
                    <span class="text-lg">Per WhatsApp teilen</span>
                </a>

                <!-- Email Button -->
                <a id="email-btn" href="#" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-6 rounded-xl flex items-center justify-center transition-all shadow-lg hover:shadow-blue-900/50 group">
                    <i class="fa-solid fa-envelope text-3xl mr-3 group-hover:scale-110 transition-transform"></i>
                    <span class="text-lg">Per E-Mail teilen ‚úâÔ∏è</span>
                </a>

                <!-- Copy Link Button -->
                <button id="copy-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-xl flex items-center justify-center transition-all shadow-lg border border-gray-700 hover:border-gray-600 group">
                    <i id="copy-icon" class="fas fa-copy text-xl mr-3 text-[#00b4d8] group-hover:text-white transition-colors"></i>
                    <span id="copy-text" class="text-lg">Link kopieren</span>
                </button>

                <!-- Save Link Button (Sticky Feature) -->
                <a id="save-btn" href="#" target="_blank" class="mt-2 text-gray-500 hover:text-gray-300 border-2 border-gray-800 hover:border-gray-700 hover:bg-white/5 font-semibold py-3 px-6 rounded-xl flex items-center justify-center transition-all group">
                    <i class="fas fa-save text-lg mr-3 group-hover:scale-110 transition-transform"></i>
                    <span>Link f√ºr mich sichern üíæ</span>
                </a>
            
            </div>
            
            <!-- Link Display (Optional) -->
             <div class="mt-4 text-xs text-gray-600 break-all select-all font-mono" id="debug-link"></div>

        </div>

        <!-- VIEW: REGISTER (Onboarding) -->
        <div id="view-register" class="hidden">
            <h1 class="text-2xl font-bold text-white mb-3">Werde <span class="text-[#00b4d8]">Scout</span>!</h1>
            <p class="text-gray-400 mb-6 font-medium">
                Registriere dich jetzt und erhalte deinen pers√∂nlichen Code zum Teilen.
            </p>

            <form id="register-form" class="text-left flex flex-col gap-4">
                <div class="flex gap-2">
                    <div class="w-1/2">
                        <label class="block text-gray-500 text-sm font-bold mb-1 ml-1">Vorname</label>
                        <input type="text" id="reg-first-name" required placeholder="Max" 
                            class="w-full p-3 bg-[#111111] border border-gray-700 rounded-xl text-white focus:outline-none focus:border-[#00b4d8] focus:ring-1 focus:ring-[#00b4d8] transition-all">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-gray-500 text-sm font-bold mb-1 ml-1">Nachname</label>
                        <input type="text" id="reg-last-name" required placeholder="Mustermann" 
                            class="w-full p-3 bg-[#111111] border border-gray-700 rounded-xl text-white focus:outline-none focus:border-[#00b4d8] focus:ring-1 focus:ring-[#00b4d8] transition-all">
                    </div>
                </div>
                <div>
                    <label class="block text-gray-500 text-sm font-bold mb-1 ml-1">E-Mail</label>
                    <input type="email" id="reg-email" required placeholder="deine@mail.de" 
                        class="w-full p-3 bg-[#111111] border border-gray-700 rounded-xl text-white focus:outline-none focus:border-[#00b4d8] focus:ring-1 focus:ring-[#00b4d8] transition-all">
                </div>

                <div id="reg-error" class="text-red-500 text-sm hidden text-center">Fehler beim Erstellen.</div>

                <button type="submit" id="reg-btn"
                    class="mt-2 bg-gradient-to-r from-[#00b4d8] to-[#0096b4] hover:from-[#00c4e8] hover:to-[#00a6c4] text-white font-bold py-4 px-6 rounded-xl flex items-center justify-center transition-all shadow-lg shadow-cyan-900/20 transform hover:-translate-y-0.5">
                    Jetzt Scout werden üöÄ
                </button>
            </form>
        </div>


        <!-- Toast (Hidden by default) -->
        <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-[#00b4d8] text-white px-6 py-3 rounded-full shadow-[0_0_20px_rgba(0,180,216,0.5)] opacity-0 transition-opacity duration-300 pointer-events-none flex items-center font-bold z-50">
            <i class="fas fa-check-circle text-white mr-2"></i> Link kopiert!
        </div>

    </div>

    <div class="mt-8 opacity-30">
        <img src="https://www.studios-in-motion.de/images/logo_studiosinmotion_2021_rahmen.svg" alt="Studios in Motion" class="h-6 mx-auto invert grayscale" onerror="this.style.display='none'">
    </div>

    <!-- SUPABASE & APP LOGIC -->
    <script type="module">
        // import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // CONFIG
        const FALLBACK_LANDING_PAGE_URL = 'https://simscouting.studios-in-motion.de/test_page.html';
        const SUPABASE_URL = 'https://rmtyebyzitzgkplxvzxg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2qDg3Jssg_fTPdXl_3Ku-g_1yOkdJ3i';
        const TENANT_ID = '79a37c78-7bdf-45e4-a631-fb47926d054d';

        // Debug Logger
        const debugArea = document.getElementById('debug-link');
        function logDebug(msg) {
            console.log(msg);
            // debugArea.innerHTML += `<div>${msg}</div>`; // Uncomment for extreme debugging
        }

        // Global Campaign State
        let currentCampaign = null;

        // Init Supabase
        let supabase;
        try {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            logDebug('Supabase Client Initialized');
        } catch (e) {
            logDebug('Supabase Init Error: ' + e.message);
            document.getElementById('stats-loader').textContent = 'Fehler: Supabase Konfiguration';
        }

        // Determine Campaign on Load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.replace(/^#\/?/, ''));
            
            const getParam = (key) => urlParams.get(key) || hashParams.get(key);

            // Robust check
            currentCampaign = getParam('campaign') || getParam('utm_campaign') || getParam('Campaign');
            
            if (currentCampaign) {
                console.log('Campaign detected:', currentCampaign);
            }
        });

        // Tracking Helper
        async function trackEvent(type, scoutId, meta = {}) {
            if (!scoutId) return;
            
            // Enrich with Campaign Data if available
            if (currentCampaign) {
                meta.campaign = currentCampaign;
            }

            try {
                await supabase.from('tracking_events').insert({
                    scout_id: scoutId,
                    event_type: type,
                    meta_data: meta
                });
                logDebug('Tracked: ' + type);
            } catch (e) {
                console.warn('Tracking failed:', e);
            }
        }


        async function initApp() {
            // Get Scout ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            let scoutId = urlParams.get('id');

            // View Elements
            const viewDashboard = document.getElementById('view-dashboard');
            const viewRegister = document.getElementById('view-register');
            const scoutNameEl = document.getElementById('scout-name');

            // Routing Logic
            if (scoutId) {
                // SHOW DASHBOARD
                viewDashboard.classList.remove('hidden');
                await initDashboard(scoutId); // Wait for dashboard init
                
                // Optional: Fetch Scout Name
                fetchScoutName(scoutId);
                
                // NEW: Load Stats (Parallel not waiting for Dashboard)
                loadStats(scoutId);
            } else {
                // SHOW REGISTRATION
                viewRegister.classList.remove('hidden');
                initRegistration();
            }
        }

        async function fetchScoutName(id) {
            try {
                // logDebug('Fetching name for ' + id);
                // V2: Fetch first_name instead of name
                const { data, error } = await supabase
                    .from('scouts')
                    .select('first_name')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;

                if (data && data.first_name) {
                    document.getElementById('scout-name').textContent = data.first_name;
                    // logDebug('Name loaded: ' + data.first_name);
                }
            } catch (e) { 
                console.log('Could not fetch name', e); 
                // document.getElementById('scout-name').textContent = 'Fehler: ' + e.message;
            }
        }

        async function initDashboard(scoutId) {
            
            // Base URL for invite link - Default to fallback
            let landingPageUrl = FALLBACK_LANDING_PAGE_URL;
            let whatsappTextTemplate = `Hey, ich lade dich zu 7 Tagen Training ein! Hol dir hier deinen Pass: {{link}}`;

            // Fetch dynamic configuration from Campaign
            try {
                const { data: campaigns, error } = await supabase
                    .from('campaigns')
                    .select('scouting_text, landingpage_url')
                    .eq('tenant_id', TENANT_ID)
                    .eq('status', 'active') 
                    .limit(1);

                if (campaigns && campaigns.length > 0) {
                    const campaign = campaigns[0];
                    if (campaign.scouting_text) {
                         // Fix: Handle literal "\n" from DB text fields as actual newlines for WhatsApp
                        whatsappTextTemplate = campaign.scouting_text.replace(/\\n/g, '\n');
                    }
                    if (campaign.landingpage_url) {
                        landingPageUrl = campaign.landingpage_url;
                    }
                }
            } catch (err) {
                console.warn('Could not load dynamic campaign settings', err);
            }

            let referralLink = `${landingPageUrl}?ref=${scoutId}`;

            // NEW: Append campaign if available
            if (currentCampaign) {
                referralLink += `&campaign=${currentCampaign}`;
            }

            // 1. WhatsApp Link
            const whatsappRefLink = `${referralLink}&source=wa`;
            // Note: whatsappTextTemplate is defined above
            const whatsappText = whatsappTextTemplate.replace('{{link}}', whatsappRefLink);
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(whatsappText)}`;

            // 2. Email Link
            const emailRefLink = `${referralLink}&source=em`;
            const emailSubject = encodeURIComponent('Ich habe ein tolles Angebot f√ºr dich gefunden! üéÅ');
            const emailBody = encodeURIComponent('Hallo,\n\nich bin gerade auf dieses Angebot gesto√üen und musste sofort an dich denken.\n\nSchau dir das mal an: ' + emailRefLink + '\n\nLiebe Gr√º√üe!');
            const emailUrl = `mailto:?subject=${emailSubject}&body=${emailBody}`;

            // Setup Buttons
            const whatsappBtn = document.getElementById('whatsapp-btn');
            whatsappBtn.href = whatsappUrl;
            whatsappBtn.onclick = () => trackEvent('share_whatsapp', scoutId, { source: 'wa' });

            // New: Email Button Logic
            const emailBtn = document.getElementById('email-btn');
            emailBtn.href = emailUrl;
            emailBtn.onclick = () => trackEvent('share_email', scoutId, { source: 'em' });
            
            // document.getElementById('debug-link').textContent = referralLink; // Optional Debug

            const copyBtn = document.getElementById('copy-btn');
            const copyText = document.getElementById('copy-text');
            const copyIcon = document.getElementById('copy-icon');

            copyBtn.onclick = () => {
                trackEvent('share_copy', scoutId, { source: 'cp' });
                // Copy Link with Source
                const copyRefLink = `${referralLink}&source=cp`;
                navigator.clipboard.writeText(copyRefLink).then(() => {
                    showToast();
                    
                    // Button Animation
                    const originalText = copyText.innerText;
                    copyText.innerText = 'Kopiert!';
                    copyIcon.classList.remove('fa-copy', 'text-[#00b4d8]');
                    copyIcon.classList.add('fa-check', 'text-green-400');
                    
                    setTimeout(() => {
                        copyText.innerText = originalText;
                        copyIcon.classList.remove('fa-check', 'text-green-400');
                        copyIcon.classList.add('fa-copy', 'text-[#00b4d8]');
                    }, 2000);
                }).catch(err => {
                    console.error('Copy failed', err);
                    alert('Konnte Link nicht kopieren: ' + referralLink);
                    alert('Falls das Kopieren nicht geht (z.B. in In-App Browsern), kopiere den Link bitte manuell:\n' + referralLink);
                });
            };

            // NEW: Save Link Logic (Sticky Feature)
            // Save the Dashboard URL (this page) so the Scout can return later
            let dashboardLink = window.location.origin + window.location.pathname + '?id=' + scoutId;
            if (currentCampaign) {
                dashboardLink += `&campaign=${currentCampaign}`;
            }
            
            const saveText = `Mein Link zum Scout-Dashboard (hier klicken zum Teilen): ${dashboardLink} \n(Am besten diese Nachricht an dich selbst schicken/speichern!)`;
            const saveUrl = `https://wa.me/?text=${encodeURIComponent(saveText)}`;
            const saveBtn = document.getElementById('save-btn');
            saveBtn.href = saveUrl;
            saveBtn.onclick = () => trackEvent('save_link', scoutId, { source: 'save' });
        }

        // NEW: Load Live Stats
        async function loadStats(scoutId) {
            const loader = document.getElementById('stats-loader');
            const container = document.getElementById('stats-container');
            const emptyState = document.getElementById('stats-empty');
            const debugLog = document.getElementById('debug-link'); // reuse debug area

            try {
                // console.log('Loading stats for', scoutId);
                
                // Count invites for this scout
                const { count, error } = await supabase
                    .from('invites')
                    .select('id', { count: 'exact', head: false }) // ensure GET request
                    .eq('scout_id', scoutId);

                if (error) {
                    // check for potential RLS 403 or network error
                    logDebug(error.message);
                    throw error;
                }

                console.log('Stats loaded:', count);

                // Hide loader
                loader.classList.add('hidden');

                // Elements
                const countEl = document.getElementById('stats-count');
                const rankEl = document.getElementById('stats-rank');

                // Logic
                if (count === null || count === 0) {
                    container.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                } else {
                    container.classList.remove('hidden');
                    emptyState.classList.add('hidden');
                    
                    countEl.textContent = count;

                    // Determine Rank
                    let rankText = 'Rookie üå±';
                    let rankClass = 'text-gray-400';

                    if (count >= 10) {
                        rankText = 'Legende üëë';
                        rankClass = 'text-yellow-400';
                    } else if (count >= 3) {
                        rankText = 'Influencer üöÄ';
                        rankClass = 'text-indigo-400';
                    }

                    rankEl.textContent = rankText;
                    rankEl.className = `text-xl font-bold ${rankClass}`;
                }

            } catch (err) {
                console.error('Error loading stats:', err);
                // Show Empty State on Error as fallback, but log it
                loader.classList.add('hidden');
                emptyState.classList.remove('hidden');
                // Optional: Show error in debug area
                // debugLog.innerText = 'Stats Error: ' + err.message;
            }
        }

        function initRegistration() {
            const form = document.getElementById('register-form');
            const btn = document.getElementById('reg-btn');
            const errorMsg = document.getElementById('reg-error');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                btn.disabled = true;
                btn.textContent = 'Erstelle Account...';
                errorMsg.classList.add('hidden');

                const firstName = document.getElementById('reg-first-name').value;
                const lastName = document.getElementById('reg-last-name').value;
                const email = document.getElementById('reg-email').value;

                try {
                    // Insert into Supabase
                    const { data, error } = await supabase
                        .from('scouts')
                        .insert({
                            tenant_id: TENANT_ID,
                            first_name: firstName,
                            last_name: lastName,
                            email: email,
                            stats: {} // Empty JSONB
                        })
                        .select(); // Return inserted record to get ID

                    if (error) throw error;

                    if (data && data.length > 0) {
                        const newScoutId = data[0].id;
                        console.log('Registered!', newScoutId);
                        // Redirect to self with new ID
                        window.location.href = `?id=${newScoutId}`;
                    } else {
                        throw new Error('No data returned');
                    }

                } catch (err) {
                    console.error('Registration error:', err);
                    errorMsg.textContent = 'Fehler: ' + (err.message || 'Unbekannter Fehler');
                    errorMsg.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = 'Jetzt Scout werden üöÄ';
                }
            });
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }

        // Run
        initApp();
    </script>
</body>
</html>
